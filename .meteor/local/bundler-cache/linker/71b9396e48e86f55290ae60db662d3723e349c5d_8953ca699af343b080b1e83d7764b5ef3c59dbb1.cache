[{"type":"js","data":"(function () {\n\n/* Imports */\nvar Meteor = Package.meteor.Meteor;\nvar global = Package.meteor.global;\nvar meteorEnv = Package.meteor.meteorEnv;\nvar Accounts = Package['accounts-base'].Accounts;\n\n(function(){\n\n///////////////////////////////////////////////////////////////////////\n//                                                                   //\n// packages/zuuk_stale-session/packages/zuuk_stale-session.js        //\n//                                                                   //\n///////////////////////////////////////////////////////////////////////\n                                                                     //\n(function () {\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                     //\n// packages/zuuk:stale-session/server.js                                                                               //\n//                                                                                                                     //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                       //\n//                                                                                                                     // 1\n// Server side activity detection for the session timeout                                                              // 2\n//                                                                                                                     // 3\n// Meteor settings:                                                                                                    // 4\n// - staleSessionInactivityTimeout: the amount of time (in ms) after which, if no activity is noticed, a session will be considered stale\n// - staleSessionPurgeInterval: interval (in ms) at which stale sessions are purged i.e. found and forcibly logged out // 6\n//                                                                                                                     // 7\nvar staleSessionPurgeInterval = Meteor.settings && Meteor.settings.public && Meteor.settings.public.staleSessionPurgeInterval || (1*60*1000); // 1min\nvar inactivityTimeout = Meteor.settings && Meteor.settings.public && Meteor.settings.public.staleSessionInactivityTimeout || (30*60*1000); // 30mins\n                                                                                                                       // 10\n//                                                                                                                     // 11\n// provide a user activity heartbeat method which stamps the user record with a timestamp of the last                  // 12\n// received activity heartbeat.                                                                                        // 13\n//                                                                                                                     // 14\nMeteor.methods({                                                                                                       // 15\n    heartbeat: function(options) {                                                                                     // 16\n        if (!this.userId) { return; }                                                                                  // 17\n        var user = Meteor.users.findOne(this.userId);                                                                  // 18\n        if (user) {                                                                                                    // 19\n            Meteor.users.update(user._id, {$set: {heartbeat: new Date()}});                                            // 20\n        }                                                                                                              // 21\n    }                                                                                                                  // 22\n});                                                                                                                    // 23\n                                                                                                                       // 24\n                                                                                                                       // 25\n//                                                                                                                     // 26\n// periodically purge any stale sessions, removing their login tokens and clearing out the stale heartbeat.            // 27\n//                                                                                                                     // 28\nMeteor.setInterval(function() {                                                                                        // 29\n    var now = new Date(), overdueTimestamp = new Date(now-inactivityTimeout);                                          // 30\n    Meteor.users.update({heartbeat: {$lt: overdueTimestamp}},                                                          // 31\n                        {$set: {'services.resume.loginTokens': []},                                                    // 32\n                         $unset: {heartbeat:1}},                                                                       // 33\n                        {multi: true});                                                                                // 34\n}, staleSessionPurgeInterval);                                                                                         // 35\n                                                                                                                       // 36\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n///////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n/* Exports */\nPackage._define(\"zuuk:stale-session\");\n\n})();\n","servePath":"/packages/zuuk_stale-session.js"}]